<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Clustering van Galen + 2019">
<meta property="og:description" content="Clustering van Galen et al + 2019
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

  <div class="container template-article">
    <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
<div class="container">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <span class="navbar-brand">
      <a class="navbar-link" href="../index.html">NCLUSION</a>
      <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title=""></span>
    </span>
  </div>

  <div id="navbar" class="navbar-collapse collapse">
    <ul class="nav navbar-nav">
<li>
<a href="../articles/get_started.html">Get started</a>
</li>
<li>
<a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
  Tutorials
   
  <span class="caret"></span>
</a>
<ul class="dropdown-menu" role="menu">
<li class="divider">
  </li>
<li><a href="../tutorials/galenAML_tutorial.html">Run
NCLUSION on van Galen
et al 2019</a></li>
  <li>
    <a href="../tutorials/tissue_tutorial.html">Run NCLUSION on Dominguez
    Conde et al 2022 </a>
  </li>
  <li>
    <a href="../tutorials/pdac_tutorial.html">Run NCLUSION on Raghavan et al 2021</a>
  </li>
  <li>
    <a href="../tutorials/pbmc_tutorial.html">Run NCLUSION on Zheng et al 2017</a>
  </li>
</ul>
  <li class="divider">
  </li>


<ul class="nav navbar-nav navbar-right">
<li>
<a href="https://github.com/microsoft/nclusion/" class="external-link">
  <span class="fab fa-github fa-lg"></span>
   
</a>
</li>
    </ul>
</div>
<!--/.nav-collapse -->
</div>
<!--/.container -->
</div>
<!--/.navbar -->
      

      </header><script src="study-compare-p-value-combine-methods_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Clustering van Galen et al 2019</h1>
    </div>
    <p>
    This tutorial demonstrates how to replicate NCLUSION clustering results for
    43,690 acute myeloid leukemia (AML) cells obtained from
    van Galen et al 2019 (PAPER REF HERE). Open a bash
    terminal and follow along with the tutorial from your working directory. </p> 
    <h2 data-toc-skip>Required Tutorial Installations</h2>
    <p>First, install NCLUSION into a Julia environment following the
    installation instructions <a
    href="../index.html">here</a>. The NCLUSION tutorials also require
    installation of additional R, python, and Julia libraries. These packages are NOT required for running NCLUSION only.</p>
      <h3 data-toc-skip>The R environment</h3>
    <p>R is a widely used, free, and open source software environment for
    statistical computing and graphics. The most recent version of R can be
    downloaded from the <a href="https://cran.r-project.org/"
    class="external-link">Comprehensive R Archive Network (CRAN)</a>. CRAN
    provides precompiled binary versions of R for Windows, macOS, and select Linux
    distributions that are likely sufficient for many users’ needs. For detailed
   installation instructions for R and R libraries click <a
    href="https://cran.r-project.org/doc/manuals/r-release/R-admin.html"
    class="external-link">here</a>.</p>
    <p>The following R libraries are required for replicating results in the
    NCLUSION tutorials: </p>
    </div>
  <ul>
  <li><a href="https://cran.r-project.org/web/packages/devtools/index.html" class="external-link"> devtools </a></li>
  <li><a href="https://cran.r-project.org/web/packages/ggplot2/index.html" class="external-link"> ggplot2 </a></li>
  <li><a href="https://cran.r-project.org/web/packages/reticulate/index.html" class="external-link"> reticulate </a></li>
  <li><a href="https://cran.r-project.org/web/packages/R.utils/index.html" class="external-link"> R.utils </a></li>
  <li><a href="https://cran.r-project.org/web/packages/stringr/index.html" class="external-link"> stringr </a></li>
  <li><a href="https://cran.r-project.org/web/packages/Matrix/index.html" class="external-link"> Matrix </a></li>
  <li><a href="https://cran.r-project.org/web/packages/Seurat/index.html" class="external-link"> Seurat </a></li>
  <li><a href="https://cran.r-project.org/web/packages/dplyr/index.html" class="external-link"> dplyr </a></li>
  <li><a href="https://cran.r-project.org/web/packages/RColorBrewer/index.html" class="external-link"> RColorBrewer </a></li>
  <li><a href="https://www.bioconductor.org/packages/release/bioc/html/SingleCellExperiment.html" class="external-link"> SingleCellExperiment </a></li>
  <li><a href="https://cran.r-project.org/web/packages/tidyverse/index.html" class="external-link"> tidyverse </a></li>
  <li><a href="https://cran.r-project.org/web/packages/scales/index.html" class="external-link"> scales </a></li>
  <li><a href="https://cran.r-project.org/web/packages/cowplot/index.html" class="external-link"> cowplot </a></li>
  <li><a href="https://cran.r-project.org/web/packages/RCurl/index.html" class="external-link"> RCurl </a></li>
  <li><a href="https://cran.r-project.org/web/packages/optparse/index.html" class="external-link"> optparse </a></li>
  <li><a href="https://bioconductor.org/packages/release/bioc/html/ComplexHeatmap.html" class="external-link"> ComplexHeatmap </a></li>
  <li><a href="https://cran.r-project.org/web/packages/circlize/index.html" class="external-link"> circilize </a></li>
  <li><a href="https://bioconductor.org/packages/release/bioc/html/clusterProfiler.html" class="external-link"> clusterProfiler </a></li>
  <li><a href="https://bioconductor.org/packages/release/bioc/html/enrichplot.html" class="external-link"> enrichplot </a></li>
  <li><a href="https://cran.r-project.org/web/packages/geneset/index.html" class="external-link"> geneset </a></li>
  <li><a href="https://cran.r-project.org/web/packages/genekitr/index.html" class="external-link"> genekitr </a></li>
  <li><a href="https://cran.r-project.org/web/packages/patchwork/index.html" class="external-link"> patchwork </a></li>
  <li><a href="https://www.bioconductor.org/packages/release/data/annotation/html/org.Hs.eg.db.html" class="external-link"> org.Hs.eg.db </a></li>
  </ul>
  <p>The easiest method to install these packages is with the following example
  command entered in an R shell:</p> <div class="sourceCode" id="cb2"><pre
  class="sourceCode R"><code class="sourceCode r">if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
  
BiocManager::install(c("SingleCellExperiment", "ComplexHeatmap",
"clusterProfiler", "enrichplot", "org.Hs.eg.db"))

<span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">install.packages</span>(<span class="kw">c</span>(<span class="st">'devtools'</span>, </span>
  <span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>                    <span class="st">'ggplot2'</span>, </span>
  <span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>                    <span class="st">'reticulate'</span>, </span>
  <span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>                    <span class="st">'R.utils'</span>, </span>
  <span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>                    <span class="st">'stringr'</span>, </span>
  <span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>                    <span class="st">'Matrix'</span>, </span>
  <span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>                    <span class="st">'Seurat'</span>, </span>
  <span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>                    <span class="st">'dplyr'</span>, </span>
  <span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>                    <span class="st">'RColorBrewer'</span>, </span>
  <span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>                    <span class="st">'tidyverse'</span>, </span>
  <span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>                    <span class="st">'scales'</span>, </span>
  <span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>                    <span class="st">'cowplot'</span>, </span>
  <span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>                    <span class="st">'RCurl'</span>,</span>
  <span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>                    <span class="st">'optparse'</span>, </span>
  <span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>                    <span class="st">'circilize'</span>, </span>
  <span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>                    <span class="st">'geneset'</span>, </span>
  <span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>                    <span class="st">'genekitr'</span>, </span>
  <span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>                    <span class="st">'patchwork'</span>), </span> 
  <span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>                    <span class="dt">dependencies =</span> <span class="ot">TRUE</span>);</span></code></pre></div>
  </div>
  <div class="section level3">
  <h3 id="installing-mvmapit-from-sources">The Python Environment<a class="anchor" aria-label="anchor" href="#installing-mvmapit-from-sources"></a>
  </h3>
  <p>We recommend that users install python packages into a new Anconda
  environment. Details for installing Anaconda and setting up a new environment
  can be found here.</p>
  <p>Packages that are required to run NCLUSION tutorials include:</p>
  <ul>
  <li><a href="https://scanpy.readthedocs.io/en/stable/" class="external-link"> scanpy </a> </li>
  <li><a
  href="https://pandas.pydata.org/pandas-docs/stable/getting_started/install.html"
  class="external-link">
  pandas </a> </li> 
  <li> <a href="https://matplotlib.org/stable/users/installing/index.html"
  class="external-link"> matplotlib </a> </li>
  <li> <a href="https://numpy.org/install/" class="external-link"> numpy </a>
  </li>
  <li> <a href="https://anndata.readthedocs.io/en/latest/" class="external-link"> anndata </a> </li>
  </ul>
  <p>To install these packages, activate a new Anaconda environment and enter the
  following commands into a bash terminal:</p>
 <pre><code>conda install -c conda-forge scanpy</code></pre>
<pre><code>conda install -c anaconda pandas</code></pre>
<pre><code>conda install -c conda-forge matplotlib</code></pre>
<pre><code>conda install -c conda-forge numpy</code></pre>
<pre><code>conda install -c conda-forge anndata</code></pre>
  </div>
  <h3 id="preprocess-data">The Julia Environment<a class="anchor" aria-label="anchor" href="#preprocess-data"></a>
  </h3> 
<p>In addition to NCLUSION, you will need to have the following Julia packages
installed: 
<ul>
  <li><a href="https://www.juliapackages.com/p/dataframesmeta" class="external-link"> DataFramesMeta </a> </li>
  <li><a
  href="https://juliapackages.com/p/hyperopt"
  class="external-link">
  Hyperopt </a> </li> 
  <li> <a href="https://juliapackages.com/p/blackboxoptim"
  class="external-link"> BlackBoxOptim </a> </li>
  <li> <a href="https://www.juliapackages.com/p/turing" class="external-link">
  Turing </a> </li>
  <li> <a href="https://juliapackages.com/p/rcall" class="external-link"> RCall
  </a> </li>
  <li> <a href="https://juliapackages.com/p/hungarian" class="external-link">
  Hungarian </a> </li>
  <li> <a href="https://www.juliapackages.com/p/combinatorics" class="external-link"> Combinatorics </a> </li>
  </ul> 
To install these packages, first start a Julia repl in your
NCLUSION Julia environment using <code>julia --project=/PATH/TO/JULIA/ENV</code>
where <code>/PATH/TO/JULIA/ENV</code> is the relative path to the NCLUSION Julia
environment, or whichever Julia environment you want to use. Then, install the
required packages by entering the following commands into the Julia repl: </p>
<pre><code>import Pkg; Pkg.add.(["DataFramesMeta", "Hyperopt", "BlackBoxOptim",
"Turing", "RCall", "Hungarian", "Combinatorics"])</code></pre>
<p>To exit the Julia repl, enter <code>exit()</code>.</p>
  <h3 id="preprocess-data">Tutorial Scripts<a class="anchor" aria-label="anchor" href="#preprocess-data"></a>
  </h3> 
    Next, download the necessary tutorial scripts
    into your current working directory with the following bash commands.
    Alternatively, you can download the tutorial files as a zipped directory
    from <a
    href="../tutorial_scripts.zip" download>here</a>, transfer them to your
    working directory, and unzip to use. 
    <pre><code>wget https://microsoft.github.io/nclusion/tutorial_scripts.zip
unzip tutorial_scripts.zip</code></pre>
    </p>

<div class="section level3">
<h2 id="preprocess-data">Download and Preprocess Data<a class="anchor" aria-label="anchor" href="#preprocess-data"></a>
</h2>
<p>The van Galen + 2019 scRNA-seq data contains 43,690 acute myeloid leukemia
(AML) cells taken from 16 AML patients, 5 healthy donors, and 2 cell lines. It
is comprised of 13,489 patient-derived malignant cells, 23,005 non-malignant
donor cells, 6,018 cells from the MUTZ-3 AML cell line, and 1,178 cells from the
OCI-AML3 cell line. The filtered, raw counts can be downloaded from <a
href="https://www.dropbox.com/s/399x045zc57fiut/Seurat_AML.rds?dl=0"
class="external-link"e>here</a>.
Alternatively, run the following <a href="https://www.gnu.org/software/wget/"
class="external-link">wget</a> commands to create a directory named
<code>tutorial_data/</code> in your current working directory and download the
data, named as <code>Seurat_AML.rds</code>, into that directory. </p>
<pre><code>mkdir -p tutorial_data/
mkdir -p tutorial_data/vanGalen2019/
cd tutorial_data/vanGalen2019/

wget https://www.dropbox.com/s/399x045zc57fiut/Seurat_AML.rds?dl=0 --content-disposition

cd ../../
</code></pre>

<p> Before running NCLUSION to cluster the van Galen + 2019 cells, the data must be
converted to an AnnData object and preprocessed. Enter the following command
into a bash terminal to extract the count and meta data from the
<code>.rds</code> object and save them as dataframes to <code>.csv</code> files,
named <code>'tutorial_data/vanGalen2019/galenAML_countsdf.csv'</code> and
<code>'tutorial_data/vanGalen2019/galenAML_metadf.csv'</code>, respectively.
<b>NOTE: </b> if you want to load packages from a specific R library, append <code>--rlib="/PATH/TO/R/LIBRARY"</code> onto
this command. </p>
<pre><code>. tutorial_scripts/convert_galen_dtype.sh --datapath="tutorial_data/vanGalen2019/Seurat_AML.rds"</code></pre>
Next, the count and cell-type data must be extracted from these dataframes to
generate an AnnData-based representation of the data. After the conversion, it is normalized to 10,000
counts per cell, log-transformed, and then
subsetted to include the top 5000 highly-variable genes. Due to the biological
differences between cell lines and donor cells of the same cell-type annotation,
we appended the cell line name onto cell-type labels where applicable, producing
33 distinct cell-types overall. These preprocessing
steps can be
executed by entering the following commands into a bash terminal. The
preprocessed data will be saved to
<code>tutorial_data/vanGalen2019/5000hvgs_vanGalen2019_preprocessed.h5ad</code>.</p> 
<pre><code>. tutorial_scripts/preprocess.sh --datapath="tutorial_data/vanGalen2019/" --savepath="tutorial_data/vanGalen2019/5000hvgs_vanGalen2019_preprocessed.h5ad" --data_name="vanGalen" --n_hvgs=5000</code></pre>  For
more detailed
documentation of this script, run <code>.
preprocess.sh --help</code>
<div class="section level3">
<h2 id="run-nclusion">Run NCLUSION<a class="anchor" aria-label="anchor" href="#run-nclusion"></a>
</h2>
<p> To run NCLUSION from your working direcorty, enter the following bash
command. <b>NOTE: set the <code>--julia_env</code> variable to the
relative path to your Julia project environment where NCLUSION is installed. </b> </p>
<pre><code>mkdir -p vanGalen2019_outputs

. tutorial_scripts/run_nclusion.sh --datapath='tutorial_data/vanGalen2019/5000hvgs_vanGalen2019_preprocessed.h5ad' --julia_env='PATH/TO/JULIA/ENV' --data_name='vanGalen2019' --output_dir='vanGalen2019_outputs/'</code></pre>
<p>All NCLUSION output files can be found in a sudirectory of the specified output
directory:
<code>vanGalen_outputs/</code>. The complete path for the output direcotry
generated by NCLUSION is as follows:
<code>vanGalen_outputs/outputs/EXPERIMENT_nclusion_vanGalen2019/DATASET_vanGalen2019_5000HVGs-43690N/YEAR_MONTH_DATE_TIME/</code>
where "YEAR_MONTH_DATE_TIME/" is equivalent to the time stamp of the results,
following the year-month-date-time format (i.e 2023-09-19T224247). An example of
the full output path might be:
<code>vanGalen_outputs/outputs/EXPERIMENT_nclusion_vanGalen2019/DATASET_vanGalen2019_5000HVGs-43690N/2023-09-19T224247/</code>. <b>NOTE: 'YEAR-MONTH-DATE-TIME'
labels in the output path/files corresponds to the time stamp of when the
results were generated. The time stamp is added automatically by NCLUSION. </b></p>
<p>In the output directory, you can find the following output files:</p>
<ol><li><b>vanGalen2019_5000HVGs-43690N_nclusion-YEAR-MONTH-DATE-TIME.csv</b>
  <ul><li>This csv file contains the NCLUSION clustering assignments, where each row displays relevant metadata and
  clustering results for each cell. </li>
  <li> The 'condition' column
    displays the cell's experimental condition labels (all cells in this study
    have the same condition label).</li> 
    <li> The 'cell_id' column displays the cell's unique identifier label. </li>
  <li> The 'cell_type' column displays the cell's manual cell-type annotation
  published in this study. This column would be empty for unannotated datasets.
  </li>
<li> The 'called_label' column displays the numerical equivalent of the
'cell_type' label, mapped automatically by NCLUSION. </li>
<li>The 'inferred_label' column displays the cell's NCLUSION cluster assignment.
</li></ul></li>
<li><b>5000G-YEAR-MONTH-DATE-TIME-pips.csv</b>
  <ul><li>This csv file contains the Posterior Inclusion Probabilities (PIPs) of
  genes across clusters identified by NCLUSION. PIPs represent the probability
  that a given variable (gene) is present in the true model of the cells'
  biology, and its value ranges from 0-1. For a particular cluster, a higher PIP
  indicates that a gene is more significant to the formation of that cluster.
</li> 
</ul></li>
<li><b>_QuickSummary_YEAR-MONTH-DATE-TIME.txt</b>
  <ul><li>This text file contains the input parameters that were used to run
  NCLUSION.</li></ul></li>
<li><b>output.jld2</b>
<ul><li>This .jld2 file contains all model parameters</li></ul></li>
<li><b>YEAR-MONTH-DATE-TIME-Nk.csv</b><ul><li>This .csv contains estimated
number of cells in each cluster identified by NCLUSION</li></ul></li>
<li><b>*_Summary.csv (if manual cell-type annotations are provided)</b></li>
<ul><li>There should be .csv files following this labeling format, corresponding to
the quantitative metrics calculated to evaluate NCLUSION performance on this
dataset. </li>
<li><b>NOTE: </b>These files are only generated if "true" cell-type labels
(manual/experimental cell-type annotations) are
provided in the "cell_type" observations layer of the AnnData input. All
tutorial datasets have "true" cell-type labels in this layer, and therefore
produce these metric calculation files (more information on these metrics below).</li></ul></ol>
</p>
<div class="section level3"><h2 id="eval-metrics">Analysis of NCLUSION
Clustering and Variable Selection<a class="anchor" aria-label="anchor" href="#eval-metrics"></a>
</h2></div>
<h3 id="eval-metrics">A. Quantitative Evaluation Metrics<a class="anchor" aria-label="anchor" href="#eval-metrics"></a>
</h3>
<p> To evaluate the clustering results, NCLUSION automatically calculates
various extrinsic evaluation metrics: Adjusted Rand Index (ARI), Jaccard Index, Normalized
Mutual Information (NMI), and Variation of Information (VarInfo). Extrinsic metric calculations dependent on
experimental annotations of the data, that act as the "true" labels. Therefore, extrinsic metrics are
only calculated when "true" labels are provided in the "cell_type" observation
layer of the input AnnData object. The metric calculations are
automatically saved to <code>.csv</code> files in the specified output
directory. Each file is labeled with the
name of the metric, appended to <code>'_Summary.csv'</code>. 
<h3 id="eval-metrics">B. Generate Cell Distribution Heatmap</h3><a class="anchor" aria-label="anchor" href="#eval-metrics"></a>
</h3>
<p>Next, generate a heatmap that displays how cells from each cell-type
(determined by the
"true" labels obtained from van Galen et al 2019) are distributed across
clusters that are identified by NCLUSION. Each row, <i>i</i>, represents one cell-type, and
each column, <i>j</i>, represents one cluster. Therefore the color intensity at
location <i>(i, j)</i> on the heatmap corresponds to percent of cells with
"true" cell-type label <i>i</i> that were assigned to cluster <i>j</i> by
NCLUSION.</p> <p>To generate the heatmap from the NCLUSION result, enter the
following commands into a bash terminal. <b>NOTE: be sure to replace --nclusion_results input with the
  relative path to your NCLUSION clustering results.</b></p>
<pre><code>. tutorial_scripts/make_heatmap.sh --nclusion_results="/PATH/TO/NCLUSION/CLUSTERING/FILE" --pct_table="vanGalen2019_outputs/cell_distribution_table.csv" --cluster_dict="vanGalen2019_outputs/cluster_mapping_to_new_label.csv" --save_heatmap="vanGalen2019_outputs/cell_distribution_heatmap.pdf"</code></pre>
<p>This will produce a pdf file named <code>vanGalen2019_outputs/vanGalen_cell_distriubtion_heatmap.pdf</code>containing the cell distriubtion heatmap shown
below. The
column labels do not correspond to NCLUSION's cluster labels. The script labels
each cluster with their positional values in the heatmap for aesthetic purposes. A
mapping of the original NCLUSION cluster labels to these new positional labels can
be found in a file named <code>vanGalen2019_outputs/mapping_cluster_to_new_label.csv</code></p>
<img src="../images/cell_distriubtion_galen_5000hvgs-1.png" width="600"
height="500">
<h3 id="tsnes">C. Annotated TSNEs <a
  class="anchor" aria-label="anchor" href="#pip-heatmaps"></a> 
  </h3>
  <p>Now, we will plot the t-distributed stochastic neighbor embedding (tSNE)
  for the data annotated with various labels: the called cell type labels that
  were published along with the data, and the NCLUSION-inferred cell type labels. We
  will also generate tSNEs corresponding to the boolean label of each cells'
  membership to a given NCLUSION-inferred cluster, such that cells assigned to cluster
  <i>n</i> are colored and all other cells are greyed out. The
  total number of tSNEs produced are equal to the total number of
  NCLUSION-inferred clusters plus two. However, for the sake of refining this analysis,
  we only display cluster membership tSNEs for clusters of interest. Run the following command to generate
  these plots. <b>NOTE: be sure to replace --nclusion_results input with the
  relative path to your NCLUSION clustering results. </b> </p>
  <pre><code>. tutorial_scripts/make_tsnes.sh --datapath="tutorial_data/vanGalen2019/5000hvgs_vanGalen2019_preprocessed.h5ad" --nclusion_results="/PATH/TO/NCLUSION/CLUSTERING/FILE" --data_name="vanGalen2019"

mv figures/ vanGalen2019_outputs/</code></pre>
  <p>All tsnes produces by this script can be found in the output directory:
    <code>vanGalen2019_outputs/figures/</code>. </p>
  <h3 id="pip-heatmaps">D. Variable Selection Analysis <a
class="anchor" aria-label="anchor" href="#pip-heatmaps"></a> 
</h3>
<p>Next, analyze results of NCLUSION's variable selection functionality to gain
insight into the biological mechanisms driving the formation of each cluster.
The reulting plots are described in detail in the following sub-sections. To
generate these plots, enter the following command into a bash terminal. </p> 
<p><b>NOTE: if you want to load packages from a specific R library, append <code>--rlib="/PATH/TO/R/LIBRARY"</code> onto
this command.  </b></p>
<p><b>NOTE: be sure to replace --nclusion_results, --pips, and --path_to_nk inputs with the
relative path to your clustering assignment, PIP, and Nk results files (generated by
NCLUSION). </b> </p>
<pre><code>. tutorial_scripts/analyze_results
--datapath="tutorial_data/vanGalen2019/5000hvgs_vanGalen2019_preprocessed.h5ad"
--pips="/PATH/TO/PIPS/FILE"
--nclusion_results="/PATH/TO/NCLUSION/CLUSTERING/FILE"
--output_dir="vanGalen2019_outputs/" --data_name='vanGalen2019' --mapping="vanGalen2019_outputs/cluster_mapping_to_new_label.csv" --path_to_nk="PATH/TO/NK/FILE"</code></pre>
<p>All plots produced by this script can be found in the specified output
directory: <code>vanGalen_outputs/</code>
  directory. Each plot is described in detail below. </p>
<h4 id="pip-heatmaps">i. Adjusted Posterior Inclusion Probability (PIP) Heatmap
<a
  class="anchor" aria-label="anchor" href="#pip-heatmaps"></a> 
  </h4>
<p>We generated a heatmap that displays adjusted Posterior Inclusion
Probabilities (PIPs) of genes across
clusters identified by NCLUSION. PIPs represent the probability that a given
variable (gene) is present in the true model of the cells' biology, and its value ranges from 0-1.
For a particular cluster, a
higher PIP indicates that a gene is more significant to the formation of that
cluster. Before generating this heatmap, the plotting script adjusted the PIP
values to account for
the number of clusters in which it is deemed significant. For example, if a gene
is deemed to be significant in driving all clusters, its PIP score will be
scaled down, as it is less helpful for identifying important differences between each
cluster compared to unique significant genes that are identified in fewer clusters. Only
genes with adjusted PIPs above a threshold of 0.5 are included in this analysis.
</p>
<img src="../images/galenAML_adjpips-1.png" height="600" width="600">
<h4 id="effectsize-heatmaps">ii. Effect Size Heatmap
  <a
    class="anchor" aria-label="anchor" href="#effectsize-heatmaps"></a> 
    </h4>
<p>The script also generated heatmap representing the effect size of the genes included
in the adjusted PIP heatmap, which is shown below. For a given cluster, the effect size of each gene
indicates whether that gene is upregulated (+) or downregulated (-) relative to cells in
other clusters. </p>
<h4 id="violin-plot">iii. Module Expression Violin Analysis<a
    class="anchor" aria-label="anchor" href="#violin-plot"></a> 
    </h4>
  <p>In addition to the heatmaps, this script generated module expression violin
  plots for select clusters of interest. Each violin plot compares the expression of
  significant genes identified in a particular cluster to the expression of
 those genes in the other clusters. </p>
  <h4 id="go-enrich">v. Gene-set Over-Enrichment (GO) Analysis<a
    class="anchor" aria-label="anchor" href="#go-enrich"></a> 
    </h4>
    <p>Lastly, this script geneated plots that display biological pathway
    enrichment analysis of cells in each cluster of interest we identified in
    the previous section. For each cluster, these pathways are identified
    based on the expression of genes with significant PIPs (>0.5).</p>
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p> Ref 1 <a href="https://doi.org/10.1093/g3journal/jkad118" class="external-link uri">https://doi.org/10.1093/g3journal/jkad118</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p> Ref 2 <a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p> Ref 3 <a href="https://doi.org/10.1073/pnas.1814092116" class="external-link uri">https://doi.org/10.1073/pnas.1814092116</a><a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>Ref 4 <a href="https://doi.org/10.1080/01621459.2018.1554485" class="external-link uri">https://doi.org/10.1080/01621459.2018.1554485</a><a href="#fnref4" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Chibuikem Nwizu, Lorin Crawford, Madeline Hughes</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

<style>pre{
  position: relative;
  margin: 5px 0 ;
  padding: 1.75rem 0 1.75rem 1rem;

  /* more stuff */
}

pre button{
  position: absolute;
  top: 5px;
  right: 5px;

  /* more stuff */
} 
pre {  
  word-wrap: normal;  
}  
</style>
<script>const copyButtonLabel = "Copy";

  // use a class selector if available
  let blocks = document.querySelectorAll("pre");
  
  blocks.forEach((block) => {
    // only add button if browser supports Clipboard API
    if (navigator.clipboard) {
      let button = document.createElement("button");
  
      button.innerText = copyButtonLabel;
      block.appendChild(button);
  
      button.addEventListener("click", async () => {
        await copyCode(block);
      });
    }
  });
  
  async function copyCode(block) {
    let code = block.querySelector("code");
    let text = code.innerText;
  
    await navigator.clipboard.writeText(text);
  }</script>


  

  </body>
</html>