
<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Empirical comparison of P-value combination methods in mvMAPIT • mvMAPIT</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Clustering van Galen + 2019">
<meta property="og:description" content="Clustering van Galen et al + 2019
">
<meta property="og:image" content="https://lcrawlab.github.io/mvMAPIT/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">NCLUSION</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title=""></span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/mvMAPIT.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    </li>
<li class="dropdown-header">Tutorials</li>
    <li>
      <a href="../articles/tutorial-docker-mvmapit.html">Dockerized mvMAPIT</a>
    </li>
    <li>
      <a href="../articles/tutorial-simulations.html">Simulate Traits</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Studies</li>
    <li>
      <a
      href="../articles/study-compare-p-value-combine-methods.html">Clustering
      van Galen + 2019</a>
    </li>
    <li>
      <a href="../articles/study-phillips-bnabs.html">Synergistic epistasis in binding affinity landscapes</a>
    </li>
    <li>
      <a href="../articles/study-wtccc-mice.html">Joint modeling of hematology traits yields epistatic signal in stock of mice</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/lcrawlab/mvMAPIT/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="study-compare-p-value-combine-methods_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Clustering van Galen et al 2019</h1>
    </div>
    <p>
    This tutorial demonstrates how to replicate NCLUSION clustering results for
    van Galen et al 2019 (PAPER REF HERE). To follow along, clone the nclusion
    repository onto your machine. This is necessary to access the data and
    analysis scripts used in the tutorial. <b>NOTE:</b> cloning the repository is NOT
    necessary for running NCLUSION only. 
    </p>

<div class="section level3">
<h3 id="preprocess-data">Preprocess Data<a class="anchor" aria-label="anchor" href="#preprocess-data"></a>
</h3>
<p>The van Galen + 2019 filtered, raw counts can be found in <a href="../tutorial_data/">tutorial_data/</a>.
Before running NCLUSION, enter the following command into a bash terminal to scale the data to 10,000 counts per
cell,
log-transform the counts, and extract the top 5000 highly-variable genes. For
more detailed documentation of this script, run <code>python
preprocess_tutorial_data.py --help</code></p>
<pre><code>python preprocess_tutorial_data.py --path_to_data tutorial_data/galenAML_raw.h5ad --path_to_save tutorial_data/5000hvgs_galenAML_preprocessed.h5ad --data_name "galen" --n_hvgs 5000</code></pre>
<div class="section level3">
<h3 id="run-nclusion">Run NCLUSION<a class="anchor" aria-label="anchor" href="#run-nclusion"></a>
</h3>
<p> In a Julia script, import the NCLUSION package and run the clustering method.</p>
<pre><code>using nclusion 

outputs_dict_vec,elsaped_time,final_elbo_vec,elbo_vec,rtik_vec,yjk_vec,perK_elbo_vec,delta_t_vec,nk_perL_vec,ηk_vec,elbologger,ηk_trend_vec_= nclusion(datafilename1,alpha1,gamma1,phi1,KMax,num_var_feat,scale_factor,seed,elbo_ep,mt_mode,logger)</code></pre>
<p>The clustering results can be found in a csv that is saved to
<code>outputs/nclusion_labels.csv</code> in your working directory, by default. </p>
<div class="section level3">
<h3 id="eval-metrics">Calculate Quantitative Evaluation Metrics<a class="anchor" aria-label="anchor" href="#eval-metrics"></a>
</h3>
<p> To evaluate the clustering results, calculate various intrinsic
(Calinski-Harabasz (CH) Index, Silhoutette (SIL) Score, and Davies-Bouldin (DB)
Index) metrics and extrinsic (Adjusted Rand Index (ARI), Jaccard Index, and Normalized
Mutual Information (NMI)) metrics. Extrinsic metric calculations dependent on
experimental annotations of the data, that are considered the "true" labels,
while intrinsic metric calculations are not. Enter the following command into a
bash terminal to compute these metrics.</p>
<pre><code>PATH_TO_RESULTS = outputs/nclusion_labels.csv
PATH_TO_NCLUSION = ~/nclusion
N_HVG = 5000
allCvi=(ch db gd43 gd53 csil ps wb xb)
cd $PATH_TO_NCLUSION
julia --project=$PATH_TO_NCLUSION $PATH_TO_NCLUSION/utility_scripts/ClusteringQualityMetrics.jl "$PATH_TO_RESULTS" "" "" "" "" "" 
for j in ${!allCvi[@]};do 
    METHOD="${allCvi[$j]}"
    echo Running $METHOD CVI calculations
    julia --project=$PATH_TO_NCLUSION $PATH_TO_NCLUSION/QuantitativeEvaluation.jl "$PATH_TO_RESULTS" "tutorial_data/5000hvgs_galenAML_preprocessed.h5ad" "$METHOD" "$N_HVG" "" "" 
done
</code></pre>
<h3 id="eval-metrics">Generate Cell Distribution Heatmap</h3><a class="anchor" aria-label="anchor" href="#eval-metrics"></a>
</h3>
<p>Next, generate a heatmap that displays how cells from each cell-type
(determined by the
"true" labels obtained from van Galen et al 2019) are distributed across
clusters that are identified by NCLUSION. Each row, <i>i</i>, represents one cell-type, and
each column, <i>j</i>, represents one cluster. Therefore the color intensity at
location <i>(i, j)</i> on the heatmap corresponds to percent of cells with
"true" cell-type label <i>i</i> that were assigned to cluster <i>j</i> by
NCLUSION.</p> To generate the heatmap from the NCLUSION result, enter the
following commands into a bash terminal.
<pre><code>python make_heatmaps.py --input_path $PATH_TO_RESULTS_5000 --pct_table_file "tutotial_outputs/pbmc_2500hvgs_NCLUSION_cell_distribution_table.csv" --cluster_dict_file "pbmc_2500hvgs_NCLUSION_cluster_mapping_to_new_label.csv" 

Rscript make_heatmaps.R -f "pbmc_2500hvgs_NCLUSION_cell_distribution_table.csv"
-s complex_heatmap.pdf</code></pre>
<p>This will produce a pdf file containing the cell distriubtion heatmap shown
below. The
column labels do not correspond to NCLUSION's cluster labels. They have been changed to
their positional values in the heatmap for aesthetic purposes. A mapping of these
new cluster labels to the original NCLUSION cluster labels can be found in a
file named <code>mapping_cluster_to_new_label.csv</code></p>
<img src="../images/cell_distriubtion_galen_5000hvgs-1.png" width="600" height="500">
<h3 id="pip-heatmaps">Variable Selection Analysis <a
class="anchor" aria-label="anchor" href="#pip-heatmaps"></a> 
</h3>
<p>Next, analyze results of NCLUSION's variable selection functionality to gain
insight into the biological mechanisms driving the formation of each cluster.
The reulting plots are described in detail in the following sub-sections. To
generate these plots, enter the following command into a bash terminal. </p>
<pre><code>PATH_TO_NCLUSION = ~/nclusion/
PATH_TO_DATA = ${PATH_TO_NCLUSION}/tutorial_data/5000hvgs_galenAML_preprocessed.h5ad
R_LIB_PATH = ~/r_packages

Rscript ${PATH_TO_NCLUSION}/utility_scripts/result_plots.R
-path_to_data=${PATH_TO_DATA} -path_to_pips="outputs/nclusion_pips.csv"
-path_to_labels="outputs/nclusion_labels.csv"
-outfile_base="outputs/" -dataset_name='galen'
-r_library_path=${R_LIB_PATH}</code></pre>
<p>The outputs of this script are described below. </p>
<h4 id="pip-heatmaps">Adjusted Posterior Inclusion Probabilities (PIPs)
and Effect Size Heatmaps<a
  class="anchor" aria-label="anchor" href="#pip-heatmaps"></a> 
  </h4>
<p>We generated a heatmap that displays adjusted Posterior Inclusion
Probabilities (PIPs) of genes across
clusters identified by NCLUSION. PIPs represent the probability that a given
variable (gene) are included in the true model, and its value ranges from 0-1.
For a particular cluster, a
higher PIP indicates that a gene is more significant to the formation of that cluster. These values have been adjusted to account for
the number of clusters in which it is deemed significant. For example, if a gene
is deemed to be significant in driving all clusters, its PIP score will be
scaled down, as it does not help us identify important differences between each
cluster as much as significant genes that are unique to specific clusters. Only
genes with adjusted PIPs above a threshold of 0.5 are included in this analysis.
</p>
<img src="../images/galenAML_adjpips-1.png" height="600" width="600">
<p>We also generated a heatmap representing the effect size of the genes included
in the adjusted PIP heatmap. For a given cluster, the effect size of each gene
indicates whether that gene is upregulated (+) or downregulated (-) relative to cells in
other clusters. </p>
<h4 id="violin-plot">Module Expression Violin Analysis<a
    class="anchor" aria-label="anchor" href="#violin-plot"></a> 
    </h4>
  <p>In addition to the heatmaps, this script generated <i>n</i> module expression violin
  plots, where <i>n</i> is equal to the number of clusters identified by
  NCLUSION. Each individual violin plot analyzes the expression of
  significant genes in cluster <i>n_i</i> relative to all of the other clusters.
  In the manuscript only clusters of interest are included, but in this tutorial
  all clusters are included. </p>
  <h4 id="pip-heatmaps">Gene-set Over-Enrichment (GO) Analysis<a
    class="anchor" aria-label="anchor" href="#pip-heatmaps"></a> 
    </h4>
    <p>Lastly, this script geneated plots that display biological pathway
    enrichment analysis of cells in each cluster. These pathways are identified
    for each cluster
    using the expression of genes with significant PIPs in that particular
    cluster. Again, in the manuscript we only display GO analyses for clusters
    of interest, but this tutorial produces plots for all clusters identified by
   NCLUSION. </p>
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p> Ref 1 <a href="https://doi.org/10.1093/g3journal/jkad118" class="external-link uri">https://doi.org/10.1093/g3journal/jkad118</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p> Ref 2 <a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p> Ref 3 <a href="https://doi.org/10.1073/pnas.1814092116" class="external-link uri">https://doi.org/10.1073/pnas.1814092116</a><a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>Ref 4 <a href="https://doi.org/10.1080/01621459.2018.1554485" class="external-link uri">https://doi.org/10.1080/01621459.2018.1554485</a><a href="#fnref4" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Chibuikem Nwizu, Lorin Crawford, Madeline Hughes</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>